steps:
- id: 'Get Version'
  name: 'ubuntu'
  entrypoint: 'bash'
  args:
  - '-c'
  - 'grep -oP "image:\s+\K(.*)" k8s/abagdemo-deploy.yaml > image_name.txt'

# Build the application container
- id: 'Build the application container'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: bash
  args: 
  - '-c'
  - 'docker build -t $(cat image_name.txt) .'

- id: 'Get Creds'
  name: gcr.io/cloud-builders/gcloud
  entrypoint: 'bash'
  args: [ '-c', 'gcloud secrets versions access latest --secret=${_GS_CREDS} > gs_creds.json' ]

- id: 'Run Unit Tests'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: 
  - '-c'
  - 'docker run --name ${_APP_NAME} --rm -v $(pwd)/tests:/abagdemo/tests -e GOOGLE_APPLICATION_CREDENTIALS=gs_creds.json $(cat image_name.txt) /bin/sh -c "/abagdemo/tests/testit.sh unit"'

substitutions:
    _APP_NAME: 'abagdemo-gcp'
    _GS_CREDS: 'last-baron-abagdemo'

options:
    substitution_option: 'ALLOW_LOOSE'